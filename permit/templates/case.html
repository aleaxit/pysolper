{% extends "base.html" %}
{% block breadcrumb %}
<a href="/applicant/home">Home</a>
{% endblock %}
{% block style %}
<style>
div.case-detail {
  border: 1px solid #ccc;
  margin-right: 300px;
}
div#action-history {
  border: 1px solid #ccc;
  width: 260px;
  float: right;
  margin-top: 0;
}
div.action {
  margin-top: 10px;
  border-top: 1px solid #ccc;
}
div.action span.timestamp {
  float: right;
}
.panel-title {
  font-weight: bold;
}
.action-form {
  float: right;
}
.action-form textarea,
.action-form div,
.action-form input {
  margin: 10px;
  float: right;
}
.action-form div {
  margin-bottom: 0;
}

.action-instruction {
  margin-right: 300px;
}

.uploadable {
  min-height: 300px;
}
</style>
{% endblock %}
{% block script %}
<script>
  $(function() {
    $('.button').button();
    $('table.tablesorter').tablesorter({
      headers: {
        4: {sorter: 'text'},
        5: {sorter: false}
      },
      sortList: [[4, 1]]
    });
  });
</script>
{% endblock %}

{% block content %}
<div>
  <h1>Details for Case: {{ case.address|e }}</h1>
</div>


<div id="action-history" class="panel">
  <div class="panel-title">Activity Log</div>
  {% for action in actions %}
  <div class="action">
    <span class="timestamp">
      {{ action.timesince }} ago
    </span>
    {{ action.action }}
    <br/>
    {{ action.actor.email }}
    {% if action.purpose %}
    <br/>
    {{ action.purpose }}
    {% endif %}
    {% if action.notes %}
    <br/>
    {{ action.notes }}
    {% endif %}
  </div>
  {% endfor %}
</div>

<div class="case-detail panel">
  <div>
    {{ case.address|e }}
  </div>
  <div>
    Created: {{ case.creation_date|e }}
  </div>
  <div>
    Status: {{ case.visible_state|e }}
  </div>
  <div>
    TODO: more info about the case
  </div>
</div>

<div class="case-detail panel">
  <div class="panel-title">Tables and Diagrams</div>
  {% for purpose in uploadables %}
  <div class="uploadable">
    <div class="panel-title">
      {{ purpose }}
    </div>
    <form class="action-form"
	  action="{{ upload_url }}" method="POST" enctype="multipart/form-data">
      <input type="hidden" name="purpose" value="{{ purpose }}">
      Notes:
      <br/>
      <textarea name="notes" rows=5 cols=40></textarea>
      <br/>
      Upload File:
      <input type="file" name="file">
      <br/>
      <input type="submit" value="Upload"
	 class="action-form button">
    </form>
    <a href="#">Start with an empty example</a>
    <p>
    {% if case.get_document(purpose) %}
    Uploaded
    {{ case.get_document(purpose).timesince }} ago
    by {{ case.get_document(purpose).actor.email }}
    ({{ case.get_document(purpose).actor.role }}).
    </p>
    {% if case.get_document(purpose).notes %}
    <pre>{{ case.get_document(purpose).notes }}</pre>
    {% endif %}
    {% if case.get_document(purpose).download_url %}
    <a href="{{ case.get_document(purpose).download_url }}">Download</a>
    {% endif %}
    {% else %}
      Missing.
    {% endif %}
    </p>
  </div>
  {% endfor %}
</div>

{% if case.visible_state != 'Submitted' %}
<div class="case-detail panel">
  <div class="panel-title">Approval</div>
  <form class="action-form"
	action="/case/submit/{{ case.key().id() }}" method="POST">
    <div>Notes for approver (optional)</div>
    <br/>
    <textarea id="notes" cols=33 rows=4></textarea>
    <br/>
    <input type="submit" class="action button" value="Submit for approval">
  </form>
  <p class="action-instruction">
    When this case is up to date and all documentation is complete, you can
    submit the case for approval.
  </p>
  <div style="clear: both"></div>
</div>
{% endif %}

<div>
  <a href="/applicant/home" class="button">
    Home
  </a>
</div>

{% endblock %}
